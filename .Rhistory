## set seed
set.seed(1234)
example_df <- read_xlsx("Example_dataset.xlsx")
meta_data <- read_xlsx("metadata.xlsx")
combined <- example_df %>%
### change the data frame from matrix to long format
## new columns "sampleID" and "reads" starting at column 4 - last column #
gather("sampleID", "reads", 4:last_col()) %>%
## combine this datatable with the metadata information, by "sampleID" column
full_join(., meta_data, by = "sampleID")
head(example_df)
head(meta_data)
head(combined)
## unique() = find all unique instances and then count them with length()
## find this data in Species_name column of example_df
length(unique(example_df$Species_name))
richness_data <- combined %>%
### group by different variables
dplyr::group_by(sampleID, Month, Site, Depth) %>%
### removing any instances of zero reads by filtering to above zero
filter(reads > 0) %>%
## calculate species richness for each group
## n_distinct() = distinct number of species_name
summarise(
richness = n_distinct(Species_name),
.groups = "keep"
)
head(richness_data)
richness_data %>%
## decide what variables to put on your x and y-axis
ggplot(., aes(x=Month, y=richness)) +
## aes() lets you adjust fill, color, shape, etc. by variable
## outside of the aes() is one value that applies to all (e.g., size=3)
geom_jitter(aes(fill=Site), shape=21, size=3, alpha=0.6, width=0.1) +
## defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
## splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
richness_data %>%
## decide what variables to put on your x and y-axis
ggplot(., aes(x=Month, y=richness)) +
## aes() lets you adjust fill, color, shape, etc. by variable
## outside of the aes() is one value that applies to all (e.g., size=3)
geom_jitter(aes(fill=Site), shape=21, size=3, alpha=0.6, width=0.1) +
## picking the colors yourself
scale_color_manual(values = c("darkblue", "firebrick")) +
## defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
## splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
richness_data %>%
## decide what variables to put on your x and y-axis
ggplot(., aes(x=Month, y=richness)) +
## aes() lets you adjust fill, color, shape, etc. by variable
## outside of the aes() is one value that applies to all (e.g., size=3)
geom_jitter(aes(fill=Site), shape=21, size=3, alpha=0.6, width=0.1) +
## picking the colors yourself
scale_fill_manual(values = c("darkblue", "firebrick")) +
## defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
## splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
richness_data %>%
## decide what variables to put on your x and y-axis
ggplot(., aes(x=Month, y=richness)) +
## aes() lets you adjust fill, color, shape, etc. by variable
## outside of the aes() is one value that applies to all (e.g., size=3)
geom_jitter(aes(fill=Site), shape=21, size=3, alpha=0.6, width=0.1) +
## picking the colors yourself
scale_fill_manual(values = c("darkblue", "firebrick")) +
#scale_color_manual(values = c("darkblue", "firebrick")) +
## defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
## splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
richness_data %>%
## decide what variables to put on your x and y-axis
ggplot(., aes(x=Month, y=richness)) +
geom_boxplot() +
## aes() lets you adjust fill, color, shape, etc. by variable
## outside of the aes() is one value that applies to all (e.g., size=3)
geom_jitter(aes(fill=Site), shape=21, size=3, alpha=0.6, width=0.1) +
## picking the colors yourself
scale_fill_manual(values = c("darkblue", "firebrick")) +
#scale_color_manual(values = c("darkblue", "firebrick")) +
## defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
## splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
richness_data %>%
## decide what variables to put on your x and y-axis
ggplot(., aes(x=Month, y=richness)) +
geom_boxplot(aes(color=Site), outlier.shape = NA) +
## aes() lets you adjust fill, color, shape, etc. by variable
## outside of the aes() is one value that applies to all (e.g., size=3)
geom_jitter(aes(fill=Site), shape=21, size=3, alpha=0.6, width=0.1) +
## picking the colors yourself
scale_fill_manual(values = c("darkblue", "firebrick")) +
scale_color_manual(values = c("darkblue", "firebrick")) +
## defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
## splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
richness_data %>%
## decide what variables to put on your x and y-axis
ggplot(., aes(x=Month, y=richness)) +
geom_boxplot(aes(color=Site), outlier.shape = NA) +
## aes() lets you adjust fill, color, shape, etc. by variable
## outside of the aes() is one value that applies to all (e.g., size=3)
geom_jitter(aes(fill=Site), shape=21, size=3, alpha=0.6) +
## picking the colors yourself
scale_fill_manual(values = c("darkblue", "firebrick")) +
scale_color_manual(values = c("darkblue", "firebrick")) +
## defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
## splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
richness_data %>%
## decide what variables to put on your x and y-axis
ggplot(., aes(x=Month, y=richness)) +
geom_boxplot(aes(color=Site), outlier.shape = NA) +
## aes() lets you adjust fill, color, shape, etc. by variable
## outside of the aes() is one value that applies to all (e.g., size=3)
geom_jitter(aes(fill=Site), shape=21, size=3, alpha=0.6, position = dodge()) +
## picking the colors yourself
scale_fill_manual(values = c("darkblue", "firebrick")) +
scale_color_manual(values = c("darkblue", "firebrick")) +
## defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
## splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
richness_data %>%
# Decide what variables to put on your x and y-axis
ggplot(aes(x = Month, y = richness)) +
geom_boxplot(aes(color = Site), outlier.shape = NA) +
# aes() lets you adjust fill, color, shape, etc. by variable
# Outside of aes() is one value that applies to all (e.g., size = 3)
geom_jitter(aes(fill = Site), shape = 21, size = 3, alpha = 0.6,
position = position_dodge(width = 0.75)) +
# Picking the colors yourself
scale_fill_manual(values = c("darkblue", "firebrick")) +
scale_color_manual(values = c("darkblue", "firebrick")) +
# Defining axis and legend labels
labs(
y = "Species Richness",
x = "Month",
fill = "Site"
) +
# Splitting graph by a variable - if using Depth, this will split the plot into Bottom and Surface
facet_wrap(~Depth) +
theme_classic()
example_df
relative_abundance_df <- example_df %>%
### convert to long format to make calculations easier
gather("sampleID", "reads", 4:last_col())
relative_abundance_df
example_df %>%
### convert to long format to make calculations easier
gather("sampleID", "reads", 4:last_col()) %>%
## calculate total # of reads per sample
group_by(sampleID) %>%
mutate(sample_total = sum(reads)) %>%
## calculate relative abundance using the sample_total calculated above
group_by(sampleID, Species_name) %>%
mutate(relab = reads/sample_total) %>% ungroup()
relative_abundance_df <- example_df %>%
### convert to long format to make calculations easier
gather("sampleID", "reads", 4:last_col()) %>%
## calculate total # of reads per sample
group_by(sampleID) %>%
mutate(sample_total = sum(reads)) %>%
## calculate relative abundance using the sample_total calculated above
group_by(sampleID, Species_name) %>%
mutate(relab = reads/sample_total) %>% ungroup() %>%
## we don't need the reads or sample_total columns anymore so we can delete these
select(-reads, -sample_total)
relative_abundance_df
relative_abundance_df <- example_df %>%
### convert to long format to make calculations easier
gather("sampleID", "reads", 4:last_col()) %>%
## calculate total # of reads per sample
group_by(sampleID) %>%
mutate(sample_total = sum(reads)) %>%
## calculate relative abundance using the sample_total calculated above
group_by(sampleID, Species_name) %>%
mutate(relab = reads/sample_total) %>% ungroup() %>%
## we don't need the reads or sample_total columns anymore so we can delete these
select(-reads, -sample_total) %>%
## adding metadata back in
full_join(., meta_data, by = "sampleID")
relative_abundance_df
head(relative_abundance_df)
## starting with the relative_abundance_df, we want to plot
relative_abundance_df %>%
## replace zeros with NAs for plotting
replace_with_na_all(condition = ~.x == 0.00000) %>%
## plot the sampleID on the x axis and the Common name of the species on the y axis
ggplot(., aes(x = sampleID, y = Common_name)) +
## create squares for every entry that will be filled with the relative abundance value
geom_tile(aes(fill = relative_abund), color = "black") +
## x, y, and legend labels (USER EDITS IF DESIRED)
labs(
y = "Common name",
x = "Site",
fill = "Relative Abundance"
) +
## color of the tile options; direction=1 will flip the low/high (USER EDITS IF DESIRED)
scale_fill_gradient(na.value = "white", low = "lightskyblue2", high = "#0C4D66") +
## split plot for Category of organism and project variables
facet_grid2(Category ~ Site,
scales = "free", space = "free",
labeller = labeller(Category = label_wrap_gen(width = 10))) +
## graph theme options
theme_classic() +
theme(
## axis text options - change size, color, angle
axis.text.x = element_text(angle = 90, size=6, color="grey25", hjust = 1),
axis.text.y = element_text(colour = 'black', size = 8),
## legend text and title - change position of legend and legend title options
legend.text = element_text(size = 8, color="black"),
legend.title = element_text(margin = margin(t = 0, r = 0, b = 5, l = 0), size=10, color="black", face="bold"),
legend.position = c(-0.4, -0.05),
legend.key.height = unit(5, 'mm'),
legend.direction = "horizontal",
legend.key.width = unit(5, 'mm'),
legend.title.align = 0.5,
legend.title.position = "top",
## axis titles - change text size, color, face (eg bold)
axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size=14, face="bold"),
axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size=14, face="bold"),
## facet wrap labels
strip.text.x = element_text(color = "black", face = "bold", size = 12),
strip.text.y = element_text(color = "black", face = "bold", size = 12, angle=0),
strip.background.y = element_blank(),
strip.clip = "off"
)
library(naniar) ## replace_with_na_all function
library(ggh4x) ## for facet wrap options
## starting with the relative_abundance_df, we want to plot
relative_abundance_df %>%
## replace zeros with NAs for plotting
replace_with_na_all(condition = ~.x == 0.00000) %>%
## plot the sampleID on the x axis and the Common name of the species on the y axis
ggplot(., aes(x = sampleID, y = Common_name)) +
## create squares for every entry that will be filled with the relative abundance value
geom_tile(aes(fill = relative_abund), color = "black") +
## x, y, and legend labels (USER EDITS IF DESIRED)
labs(
y = "Common name",
x = "Site",
fill = "Relative Abundance"
) +
## color of the tile options; direction=1 will flip the low/high (USER EDITS IF DESIRED)
scale_fill_gradient(na.value = "white", low = "lightskyblue2", high = "#0C4D66") +
## split plot for Category of organism and project variables
facet_grid2(Category ~ Site,
scales = "free", space = "free",
labeller = labeller(Category = label_wrap_gen(width = 10))) +
## graph theme options
theme_classic() +
theme(
## axis text options - change size, color, angle
axis.text.x = element_text(angle = 90, size=6, color="grey25", hjust = 1),
axis.text.y = element_text(colour = 'black', size = 8),
## legend text and title - change position of legend and legend title options
legend.text = element_text(size = 8, color="black"),
legend.title = element_text(margin = margin(t = 0, r = 0, b = 5, l = 0), size=10, color="black", face="bold"),
legend.position = c(-0.4, -0.05),
legend.key.height = unit(5, 'mm'),
legend.direction = "horizontal",
legend.key.width = unit(5, 'mm'),
legend.title.align = 0.5,
legend.title.position = "top",
## axis titles - change text size, color, face (eg bold)
axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size=14, face="bold"),
axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size=14, face="bold"),
## facet wrap labels
strip.text.x = element_text(color = "black", face = "bold", size = 12),
strip.text.y = element_text(color = "black", face = "bold", size = 12, angle=0),
strip.background.y = element_blank(),
strip.clip = "off"
)
relative_abundance_df <- example_df %>%
### convert to long format to make calculations easier
gather("sampleID", "reads", 4:last_col()) %>%
## calculate total # of reads per sample
group_by(sampleID) %>%
mutate(sample_total = sum(reads)) %>%
## calculate relative abundance using the sample_total calculated above
group_by(sampleID, Species_name) %>%
mutate(relative_abund = reads/sample_total) %>% ungroup() %>%
## we don't need the reads or sample_total columns anymore so we can delete these
select(-reads, -sample_total) %>%
## adding metadata back in
full_join(., meta_data, by = "sampleID")
## starting with the relative_abundance_df, we want to plot
relative_abundance_df %>%
## replace zeros with NAs for plotting
replace_with_na_all(condition = ~.x == 0.00000) %>%
## plot the sampleID on the x axis and the Common name of the species on the y axis
ggplot(., aes(x = sampleID, y = Common_name)) +
## create squares for every entry that will be filled with the relative abundance value
geom_tile(aes(fill = relative_abund), color = "black") +
## x, y, and legend labels (USER EDITS IF DESIRED)
labs(
y = "Common name",
x = "Site",
fill = "Relative Abundance"
) +
## color of the tile options; direction=1 will flip the low/high (USER EDITS IF DESIRED)
scale_fill_gradient(na.value = "white", low = "lightskyblue2", high = "#0C4D66") +
## split plot for Category of organism and project variables
facet_grid2(Category ~ Site,
scales = "free", space = "free",
labeller = labeller(Category = label_wrap_gen(width = 10))) +
## graph theme options
theme_classic() +
theme(
## axis text options - change size, color, angle
axis.text.x = element_text(angle = 90, size=6, color="grey25", hjust = 1),
axis.text.y = element_text(colour = 'black', size = 8),
## legend text and title - change position of legend and legend title options
legend.text = element_text(size = 8, color="black"),
legend.title = element_text(margin = margin(t = 0, r = 0, b = 5, l = 0), size=10, color="black", face="bold"),
legend.position = c(-0.4, -0.05),
legend.key.height = unit(5, 'mm'),
legend.direction = "horizontal",
legend.key.width = unit(5, 'mm'),
legend.title.align = 0.5,
legend.title.position = "top",
## axis titles - change text size, color, face (eg bold)
axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size=14, face="bold"),
axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size=14, face="bold"),
## facet wrap labels
strip.text.x = element_text(color = "black", face = "bold", size = 12),
strip.text.y = element_text(color = "black", face = "bold", size = 12, angle=0),
strip.background.y = element_blank(),
strip.clip = "off"
)
### save plot to your computer so you can see this bigger
ggave("Totalspecies.png", width=10, height=12)
### save plot to your computer so you can see this bigger
ggsave("Totalspecies.png", width=10, height=12)
### save plot to your computer so you can see this bigger
ggsave("Totalspecies.png", width=13, height=11)
## starting with the relative_abundance_df, we want to plot
relative_abundance_df %>%
## replace zeros with NAs for plotting
replace_with_na_all(condition = ~.x == 0.00000) %>%
## plot the sampleID on the x axis and the Common name of the species on the y axis
ggplot(., aes(x = sampleID, y = Common_name)) +
## create squares for every entry that will be filled with the relative abundance value
geom_tile(aes(fill = relative_abund), color = "black") +
## x, y, and legend labels (USER EDITS IF DESIRED)
labs(
y = "Common name",
x = "Sample",
fill = "Relative Abundance"
) +
## color of the tile options; direction=1 will flip the low/high (USER EDITS IF DESIRED)
scale_fill_gradient(na.value = "white", low = "lightskyblue2", high = "#0C4D66") +
## split plot for Category of organism and project variables
facet_grid2(Category ~ Site,
scales = "free", space = "free",
labeller = labeller(Category = label_wrap_gen(width = 10))) +
## graph theme options
theme_classic() +
theme(
## axis text options - change size, color, angle
axis.text.x = element_text(angle = 90, size=6, color="grey25", hjust = 1),
axis.text.y = element_text(colour = 'black', size = 8),
## legend text and title - change position of legend and legend title options
legend.text = element_text(size = 8, color="black"),
legend.title = element_text(margin = margin(t = 0, r = 0, b = 5, l = 0), size=10, color="black", face="bold"),
legend.position = "right",
legend.key.height = unit(5, 'mm'),
legend.direction = "horizontal",
legend.key.width = unit(5, 'mm'),
legend.title.align = 0.5,
legend.title.position = "top",
## axis titles - change text size, color, face (eg bold)
axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size=14, face="bold"),
axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size=14, face="bold"),
## facet wrap labels
strip.text.x = element_text(color = "black", face = "bold", size = 12),
strip.text.y = element_text(color = "black", face = "bold", size = 12, angle=0),
strip.background.y = element_blank(),
strip.clip = "off"
)
### save plot to your computer so you can see this bigger
ggsave("Totalspecies.png", width=13, height=11)
library(ggplot2) ## for plotting
library(dplyr) ## for data table manipulation
library(tidyr) ## for data table manipulation
library(readr) ## for reading in tsv files
library(readxl) ## for reading in excel files
library(stringr) ## for data transformation
library(strex) ## for data transformation
library(writexl) ## for excel output
library(purrr) ## for data transformation
library(funrar) ## for make_relative()
library(tidyverse) ## for data table manipulation
library(Biostrings) ## for reading in fasta file
library(data.table)  ## for data table manipulation
## GMGI Fish database
path_GMGIdb = "C:/BoxDrive/Box/Science/Fisheries/Projects/eDNA/Metabarcoding Lab Resources/Reference Databases/GMGI_Vert_Ref.xlsx"
## BLAST results
path_blast_gmgi = "docs/eDNA 12S metab/example_input/blast/BLASTResults_GMGI.txt"
path_blast_mito = "docs/eDNA 12S metab/example_input/blast/BLASTResults_Mito.txt"
path_blast_ncbi_taxassigned = "docs/eDNA 12S metab/example_input/blast/NCBI_taxassigned.txt"
path_blast_ncbi = "docs/eDNA 12S metab/example_input/blast/BLASTResults_NCBI.txt"
## ASV table results
## confirm that the ASV_table.len.tsv name is correct for user's project
path_asv_table = "docs/eDNA 12S metab/example_input/ASV_table.len.tsv"
path_seq_file = "docs/eDNA 12S metab/example_input/ASV_seqs.len.fasta"
path_output_summary = "docs/eDNA 12S metab/example_input/overall_summary.tsv"
### TAXONOMIC CHOICES
# output paths
path_choice_required = "docs/eDNA 12S metab/example_output/taxonomic_assignments/Choice_required_GMGI_multiplehits.xlsx"
path_choice_required_edited="docs/eDNA 12S metab/example_output/taxonomic_assignments/Choice_required_GMGI_multiplehits_edited.xlsx"
path_disagree_list = "docs/eDNA 12S metab/example_output/taxonomic_assignments/Three_DB_comparison_taxonomic_ID.xlsx"
path_disagree_list_edited="docs/eDNA 12S metab/example_output/taxonomic_assignments/Three_DB_comparison_taxonomic_ID_edited.xlsx"
path_commonnames_add="docs/eDNA 12S metab/example_output/taxonomic_assignments/CommonNames_required.xlsx"
path_commonnames_add_edited="docs/eDNA 12S metab/example_output/taxonomic_assignments/CommonNames_required_edited.xlsx"
reads_filtered_percent_out="docs/eDNA 12S metab/example_output/Filtered_Percent_removed_reads.xlsx"
reads_filtered10_out="docs/eDNA 12S metab/example_output/Filtered_10_removed_reads.xlsx"
Species_breakdown_sheet="docs/eDNA 12S metab/example_output/Summary_Species_level.xlsx"
ASV_breakdown_sheet="docs/eDNA 12S metab/example_output/Summary_ASV_level.xlsx"
read_excel("docs/eDNA 12S metab/example_input/metadata_tidal_cycle.xlsx")
## EXCEL
meta <- read_excel("docs/eDNA 12S metab/example_input/metadata_tidal_cycle.xlsx") %>%
## ampliseq needs _ but the MiSeq needs -
mutate(`GMGI Sample ID` = gsub("-", "_", `GMGI Sample ID`))
# Load GMGI database information (common name, species name, etc.)
gmgi_db <- read_xlsx(path_GMGIdb, sheet = 1) %>% dplyr::rename(sseqid = Ref) %>%
## removing > from beginning of entires within Ref column
mutate(sseqid = gsub(">", "", sseqid))
## Setting column header names and classes
blast_col_headers = c("ASV_ID", "sseqid", "pident", "length", "mismatch", "gapopen",
"qstart", "qend", "sstart", "send", "evalue", "bitscore")
blast_col_classes = c(rep("character", 2), rep("numeric", 10))
Blast_GMGI <- read.table(path_blast_gmgi, header=F, col.names = blast_col_headers, colClasses = blast_col_classes) %>%
## blast changes spaces to hyphons so we need to change that back to match our metadata
mutate(sseqid = gsub("-", " ", sseqid)) %>%
## join with GMGI database information
left_join(., gmgi_db, by = "sseqid") %>%
## only keep the first human hit if there are multiple (this is already ordered by pident)
group_by(ASV_ID) %>%
filter(!(str_detect(sseqid, "Human") & row_number() > 1)) %>%
ungroup()
## Check how many ASVs were identified with the GMGI Database
length(unique(Blast_GMGI$ASV_ID))
Blast_Mito <- read.table(path_blast_mito, header=F, col.names = blast_col_headers, colClasses = blast_col_classes) %>%
# renaming sseqid to species name
dplyr::rename(Species_name = sseqid) %>%
# replacing _ with spaces
mutate(Species_name = gsub("_", " ", Species_name),
## removing gb || sequence from species name
### uncomment if we need this line again
Species_name = str_after_nth(Species_name, "\\|", 2)
)
Blast_Mito
NCBI_taxassigned <- read.delim2(path_blast_ncbi_taxassigned, header=F, col.names = c("staxid", "Phylo")) %>%
## creating taxonomic assignment columns
separate(Phylo, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species_name"), sep = ";") %>%
## creating species column based on Species_name
mutate(., species = str_after_nth(Species_name, " ", 1))
Blast_NCBI <- read.table(path_blast_ncbi, header=F,
col.names = c("ASV_ID", "sseqid", "sscinames", "staxid", "pident", "length", "mismatch",
"gapopen", "qstart", "qend", "sstart", "send", "evalue", "bitscore"),
colClasses = c(rep("character", 3), "integer", rep("numeric", 9))) %>%
left_join(., NCBI_taxassigned, by = "staxid")
